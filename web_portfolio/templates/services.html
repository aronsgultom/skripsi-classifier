{% extends "base.html" %}

{% block title %}Layanan Dokumen - Academic Portfolio{% endblock %}

{% block content %}
<!-- Flash Messages Data for JavaScript -->
<div id="flash-messages" style="display: none;">
  {% with messages = get_flashed_messages(with_categories=True) %}
    {% if messages %}
      {% for category, message in messages %}
        <div data-category="{{ category }}" data-message="{{ message }}"></div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<div class="max-w-6xl mx-auto">
  <!-- Header -->
  <div class="bg-gradient-to-r from-teal-600 via-emerald-500 to-green-500 rounded-2xl p-8 text-white shadow-2xl mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold mb-2">Layanan Dokumen</h1>
        <p class="text-emerald-50 text-lg">Upload dan klasifikasikan dokumen BKD Anda secara otomatis</p>
      </div>
      <div class="hidden md:block">
        <div class="w-20 h-20 bg-white/20 rounded-2xl flex items-center justify-center">
          <i class="fas fa-brain text-3xl"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Section -->
  <div class="bg-white/80 backdrop-blur-lg rounded-2xl shadow-2xl border border-emerald-50 overflow-hidden mb-8">
    <div class="bg-gradient-to-r from-emerald-50 to-teal-50 px-8 py-6 border-b border-emerald-100">
      <h2 class="text-2xl font-bold text-slate-900">
        <i class="fas fa-cloud-upload-alt text-emerald-600 mr-3"></i>Upload Dokumen
      </h2>
      <p class="text-slate-500 mt-1">Mohon unggah dokumen PDF yang akan diproses. Teks dari dokumen tersebut kemudian akan diekstraksi dan diklasifikasikan menggunakan model yang telah tersedia.</p>
    </div>

    <div class="p-8">
      <form method="POST" enctype="multipart/form-data" action="{{ url_for('services.upload') }}" class="space-y-6">
        <!-- Upload Area -->
        <div class="border-2 border-dashed border-emerald-200 rounded-2xl p-12 text-center hover:border-emerald-400 transition-all duration-300 bg-gradient-to-br from-white to-emerald-50/80">
          <div class="w-16 h-16 bg-emerald-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-file-pdf text-emerald-600 text-2xl"></i>
          </div>
          <h3 class="text-xl font-bold text-slate-900 mb-2">Pilih Dokumen PDF</h3>
          <p class="text-slate-500 mb-6">Pilih dokumen Beban Kerja Dosen (BKD)</p>

          <input type="file" name="file" accept=".pdf" required
                 class="block w-full text-sm text-slate-600 file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 file:transition-all file:duration-300">

          <div class="mt-4 text-xs text-slate-500">
            <i class="fas fa-info-circle mr-1 text-emerald-500"></i>
            Format: PDF â€¢ Maks: 10MB
          </div>
        </div>

        <!-- AI Features -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-teal-50 rounded-xl p-6 text-center border border-teal-100">
            <div class="w-12 h-12 bg-teal-100 rounded-xl flex items-center justify-center mx-auto mb-3">
              <i class="fas fa-eye text-teal-600"></i>
            </div>
            <h4 class="font-bold text-slate-900 mb-2">Ekstraksi Teks</h4>
            <p class="text-sm text-slate-500">Dokumen akan melalui proses ekstraksi teks untuk mengambil data teks.</p>
          </div>

          <div class="bg-emerald-50 rounded-xl p-6 text-center border border-emerald-100">
            <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center mx-auto mb-3">
              <i class="fas fa-brain text-emerald-600"></i>
            </div>
            <h4 class="font-bold text-slate-900 mb-2">Klasifikasi Otomatis</h4>
            <p class="text-sm text-slate-500">Implementasi Model Latent Semantic Indexing (LSI) dikombinasikan dengan Cosine Similarity atau K-Nearest Neighbor (KNN) untuk menentukan kategori dokumen.</p>
          </div>

          <div class="bg-green-50 rounded-xl p-6 text-center border border-green-100">
            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-3">
              <i class="fas fa-tags text-green-600"></i>
            </div>
            <h4 class="font-bold text-slate-900 mb-2">Masuk ke Portofolio</h4>
            <p class="text-sm text-slate-500">Hasil klasifikasi dapat secara langsung disusun berdasarkan kategori Beban Kerja Dosen (BKD).</p>
          </div>
        </div>

        <!-- Submit Button -->
        <button type="submit"
                class="w-full bg-gradient-to-r from-teal-600 via-emerald-500 to-green-500 text-white py-4 px-6 rounded-xl hover:from-teal-700 hover:via-emerald-600 hover:to-green-600 transition-all duration-300 font-bold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
          <i class="fas fa-upload mr-2"></i>Upload & Klasifikasikan Dokumen
        </button>
      </form>
    </div>
  </div>

  <!-- Documents History (no horizontal scroll) -->
  <div class="bg-white/80 backdrop-blur-lg rounded-2xl shadow-2xl border border-emerald-50 overflow-hidden">
    <div class="bg-gradient-to-r from-emerald-50 to-teal-50 px-8 py-6 border-b border-emerald-100">
      <h2 class="text-2xl font-bold text-slate-900">
        <i class="fas fa-history text-emerald-600 mr-3"></i>Riwayat Dokumen
      </h2>
      <p class="text-slate-500 mt-1">Dokumen yang sudah diunggah & hasil klasifikasinya</p>
    </div>

    <!-- Hapus overflow-x-auto; pakai table-fixed + word wrapping -->
    <div>
      {% if documents %}
      <table class="w-full table-fixed">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider break-words whitespace-normal w-2/5 sm:w-1/3">
              <i class="fas fa-file mr-2"></i>Dokumen
            </th>
            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider break-words whitespace-normal w-1/5">
              <i class="fas fa-tag mr-2"></i>Klasifikasi
            </th>
            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider break-words whitespace-normal w-1/5">
              <i class="fas fa-calendar mr-2"></i>Tanggal Unggah
            </th>
            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider break-words whitespace-normal w-1/6">
              <i class="fas fa-chart-line mr-2"></i>Status
            </th>
            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider break-words whitespace-normal w-1/6">
              <i class="fas fa-cogs mr-2"></i>Aksi
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-slate-100">
          {% for doc in documents %}
          <tr class="hover:bg-emerald-50/40 transition-colors duration-200 align-top">
            <td class="px-6 py-4 whitespace-normal break-words align-top">
              <div class="flex items-start">
                <div class="w-10 h-10 flex-shrink-0 bg-emerald-100 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-file-pdf text-emerald-600"></i>
                </div>
                <div class="min-w-0">
                  <div class="text-sm font-bold text-slate-900 break-words whitespace-normal max-w-[220px] sm:max-w-none">
                    {{ doc.file_name }}
                  </div>
                  <div class="text-xs text-slate-400">PDF Document</div>
                </div>
              </div>
            </td>

            <td class="px-6 py-4 whitespace-normal break-words align-top">
              {% if doc.predicted_category and doc.predicted_category != 'Unclassified' %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700 break-words">
                  <i class="fas fa-check-circle mr-1"></i>
                  {{ doc.predicted_category.replace('_', ' ').title() }}
                </span>
              {% else %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-800 break-words">
                  <i class="fas fa-question-circle mr-1"></i>
                  Unclassified
                </span>
              {% endif %}
            </td>

            <td class="px-6 py-4 whitespace-normal break-words text-sm text-slate-500 align-top">
              {{ doc.uploaded_at.strftime('%B %d, %Y') }}<br>
              <span class="text-xs">{{ doc.uploaded_at.strftime('%I:%M %p') }}</span>
            </td>

            <td class="px-6 py-4 whitespace-normal break-words align-top">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-teal-100 text-teal-700">
                <i class="fas fa-check mr-1"></i>
                Processed
              </span>
            </td>

            <td class="px-6 py-4 whitespace-normal break-words align-top">
              <button onclick="deleteDocument('{{ doc.id }}')"
                      class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-xs font-medium transition-colors duration-200 inline-flex items-center">
                <i class="fas fa-trash mr-1"></i>Hapus
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="text-center py-12">
        <div class="w-16 h-16 bg-emerald-50 rounded-2xl flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-inbox text-emerald-300 text-2xl"></i>
        </div>
        <h3 class="text-lg font-bold text-slate-900 mb-2">Belum ada dokumen</h3>
        <p class="text-slate-500">Silakan upload dokumen BKD Anda pada form di atas.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
// Process flash messages on page load
document.addEventListener('DOMContentLoaded', function() {
  const flashContainer = document.getElementById('flash-messages');
  if (flashContainer) {
    const messageElements = flashContainer.querySelectorAll('[data-message]');
    messageElements.forEach(element => {
      const category = element.getAttribute('data-category') || 'info';
      const message = element.getAttribute('data-message');
      if (message && typeof showNotification === 'function') {
        const mapped = (category === 'error') ? 'error'
                     : (category === 'success') ? 'success'
                     : 'info';
        showNotification(message, mapped);
      }
    });
  }
});

function deleteDocument(documentId) {
  if (confirm('Yakin hapus dokumen ini? Data tidak bisa dikembalikan.')) {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Menghapus...';
    button.disabled = true;

    fetch(`/delete_document/${documentId}`, { method: 'DELETE' })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          if (typeof showNotification === 'function') {
            showNotification(data.message, 'success');
          }
          setTimeout(() => { window.location.reload(); }, 800);
        } else {
          if (typeof showNotification === 'function') {
            showNotification(data.message, 'error');
          }
          button.innerHTML = originalText;
          button.disabled = false;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        if (typeof showNotification === 'function') {
          showNotification('Error deleting document', 'error');
        }
        button.innerHTML = originalText;
        button.disabled = false;
      });
  }
}
</script>
{% endblock %}
